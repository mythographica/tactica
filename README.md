# @mnemonica/tactica

**TypeScript Language Service Plugin for Mnemonica**

Tactica generates type definitions for Mnemonica's dynamic nested constructors, enabling TypeScript to understand runtime type hierarchies created through `define()` and `decorate()` calls.

## The Problem

Mnemonica enables powerful instance-level inheritance:

```typescript
const UserType = define('UserType', function (this: { name: string }) {
    this.name = '';
});

const AdminType = UserType.define('AdminType', function (this: { role: string }) {
    this.role = 'admin';
});

const user = new UserType();
const admin = new user.AdminType(); // Works at runtime!
```

But TypeScript doesn't know that `user.AdminType` exists because `UserType.define()` is a runtime operation.

## The Solution

Tactica analyzes your TypeScript source files and generates declaration files that tell TypeScript about the nested constructor hierarchy.

## Installation

```bash
npm install --save-dev @mnemonica/tactica
```

## Usage

### 1. As a TypeScript Language Service Plugin (Recommended)

Add to your `tsconfig.json`:

```json
{
  "compilerOptions": {
    "plugins": [
      {
        "name": "@mnemonica/tactica",
        "outputDir": ".mnemonica",
        "include": ["src/**/*.ts"],
        "exclude": ["**/*.test.ts", "**/*.spec.ts"]
      }
    ]
  }
}
```

Then include the generated types in your project:

```json
{
  "compilerOptions": {
    "typeRoots": ["./node_modules/@types", "./.mnemonica"]
  }
}
```

### 2. As a CLI Tool

Generate types once:

```bash
npx tactica
```

Watch mode for development:

```bash
npx tactica --watch
```

With custom options:

```bash
npx tactica --project ./src/tsconfig.json --output ./types/mnemonica
```

### 3. As a Module

```typescript
import { MnemonicaAnalyzer, TypesGenerator, TypesWriter } from '@mnemonica/tactica';
import * as ts from 'typescript';

const program = ts.createProgram(['./src/index.ts'], {});
const analyzer = new MnemonicaAnalyzer(program);

for (const sourceFile of program.getSourceFiles()) {
    if (!sourceFile.isDeclarationFile) {
        analyzer.analyzeFile(sourceFile);
    }
}

const generator = new TypesGenerator(analyzer.getGraph());
const generated = generator.generate();

const writer = new TypesWriter('.mnemonica');
writer.write(generated);
```

## Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `outputDir` | string | `.mnemonica` | Directory for generated types |
| `include` | string[] | `['**/*.ts']` | File patterns to include |
| `exclude` | string[] | `['**/*.d.ts']` | File patterns to exclude |
| `verbose` | boolean | `false` | Enable verbose logging |

## Generated Output

Tactica generates `.mnemonica/types.d.ts`:

```typescript
// Generated by @mnemonica/tactica - DO NOT EDIT
import { IDefinitorInstance, MnemonicaInstance, SN } from 'mnemonica';

interface MnemonicaTypeRegistry {
  UserType: {
    properties: { name: string };
    subtypes: {
      AdminType: {
        properties: { role: string };
        subtypes: {};
      };
    };
  };
}

declare module "mnemonica" {
  interface UserTypeInstance extends MnemonicaInstance {
    AdminType: IDefinitorInstance<AdminTypeInstance, SN>;
  }
  
  interface AdminTypeInstance extends UserTypeInstance, MnemonicaInstance {
    // subtypes...
  }
}
```

## What Gets Analyzed

### 1. define() Calls

```typescript
// Root type
const UserType = define('UserType', function (this: { name: string }) {
    this.name = '';
});

// Nested type
const AdminType = UserType.define('AdminType', function (this: { role: string }) {
    this.role = 'admin';
});
```

### 2. @decorate() Decorator

```typescript
@decorate()
class User {
    name: string = '';
}

@decorate(User)
class Admin {
    role: string = 'admin';
}
```

### 3. Object.assign Pattern

```typescript
const UserType = define('UserType', function (this: any, data: any) {
    Object.assign(this, data);
});
```

## Integration with Your Workflow

### .gitignore

Tactica automatically adds `.mnemonica/` to your `.gitignore` if not already present.

### IDE Support

With the Language Service Plugin:
- **VS Code**: Automatic type updates on file save
- **WebStorm**: Works with TypeScript service
- **Vim/Neovim**: Works with coc.nvim, nvim-lspconfig

## API Reference

### MnemonicaAnalyzer

```typescript
class MnemonicaAnalyzer {
    constructor(program?: ts.Program);
    analyzeFile(sourceFile: ts.SourceFile): AnalyzeResult;
    analyzeSource(sourceCode: string, fileName?: string): AnalyzeResult;
    getGraph(): TypeGraphImpl;
}
```

### TypeGraphImpl

```typescript
class TypeGraphImpl implements TypeGraph {
    roots: Map<string, TypeNode>;
    allTypes: Map<string, TypeNode>;
    addRoot(node: TypeNode): void;
    addChild(parent: TypeNode, child: TypeNode): void;
    findType(fullPath: string): TypeNode | undefined;
    getAllTypes(): TypeNode[];
    *bfs(): Generator<TypeNode>;
    *dfs(node?: TypeNode): Generator<TypeNode>;
}
```

### TypesGenerator

```typescript
class TypesGenerator {
    constructor(graph: TypeGraphImpl);
    generate(): GeneratedTypes;
    generateSingleType(node: TypeNode): string;
}
```

### TypesWriter

```typescript
class TypesWriter {
    constructor(outputDir?: string);
    write(generated: GeneratedTypes): string;
    writeTo(filename: string, content: string): string;
    clean(): void;
    getOutputDir(): string;
}
```

## How It Works

1. **Parse**: TypeScript AST is parsed to find `define()` and `decorate()` calls
2. **Analyze**: The analyzer extracts type names, properties, and hierarchy
3. **Graph**: A Trie (tree) structure represents the type hierarchy
4. **Generate**: TypeScript declarations are generated from the graph
5. **Output**: Files are written to `.mnemonica/` directory

```
Type Hierarchy (Trie)
├── UserType
│   ├── properties: { name: string }
│   └── AdminType
│       ├── properties: { role: string }
│       └── SuperAdminType
│           └── properties: { permissions: string[] }
└── OrderType
    └── properties: { items: Item[] }
```

## Troubleshooting

### Types not updating

1. Check that the plugin is loaded in `tsconfig.json`
2. Restart TypeScript service (VS Code: Command Palette → "TypeScript: Restart TS Server")
3. Verify file patterns in `include`/`exclude` config

### Generated types have errors

1. Ensure all mnemonica types have explicit type annotations
2. Check that `define()` calls use string literals for type names
3. Verify property types are valid TypeScript

### Plugin not working

```bash
# Test with CLI first
npx tactica --verbose

# Check for parsing errors
npx tactica --verbose 2>&1 | grep -i error
```

## Related Projects

- [mnemonica](https://github.com/wentout/mnemonica) - Instance inheritance system
- [@mnemonica/topologica](https://github.com/mythographica/topologica) - Filesystem-based type discovery

## License

MIT

## Contributing

Contributions welcome! Please read the [Contributing Guide](CONTRIBUTING.md) for details.
