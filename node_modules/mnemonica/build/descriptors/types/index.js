'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.types = void 0;
const constants_1 = require("../../constants");
const { odp, SymbolConstructorName, SymbolDefaultTypesCollection, SymbolConfig, defaultOptions, defaultOptionsKeys, MNEMONICA, MNEMOSYNE, } = constants_1.constants;
const types_1 = require("../../api/types");
const hooksAPI = require("../../api/hooks");
const { registerHook, invokeHook, registerFlowChecker, } = hooksAPI;
const typesCollections = new Map();
const TypesCollection = function (_config) {
    const self = this;
    const subtypes = new Map();
    const config = defaultOptionsKeys.reduce((o, key) => {
        const value = _config[key];
        const option = defaultOptions[key];
        const t_conf = typeof value;
        const t_opts = typeof option;
        if (t_conf === t_opts) {
            o[key] = value;
        }
        else {
            o[key] = option;
        }
        return o;
    }, {});
    odp(this, SymbolConfig, {
        get() {
            return config;
        }
    });
    odp(this, Symbol.hasInstance, {
        get() {
            return (instance) => {
                return instance[SymbolConstructorName] === MNEMONICA;
            };
        }
    });
    odp(this, 'subtypes', {
        get() {
            return subtypes;
        }
    });
    odp(subtypes, MNEMOSYNE, {
        get() {
            return typesCollections.get(self);
        }
    });
    odp(this, MNEMOSYNE, {
        get() {
            return typesCollections.get(self);
        }
    });
    const hooks = Object.create(null);
    odp(this, 'hooks', {
        get() {
            return hooks;
        }
    });
};
odp(TypesCollection.prototype, MNEMONICA, {
    get() {
        return typesCollections.get(this);
    }
});
odp(TypesCollection.prototype, 'define', {
    get() {
        const { subtypes } = this;
        return function (TypeOrTypeName, constructHandlerOrConfig, config) {
            return types_1.define.call(this, subtypes, TypeOrTypeName, constructHandlerOrConfig, config);
        };
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'lookup', {
    get() {
        return function (TypeNestedPath) {
            return types_1.lookup.call(this.subtypes, TypeNestedPath);
        }.bind(this);
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'registerHook', {
    get() {
        const self = this;
        return function (hookName, hookCallback) {
            return registerHook.call(self, hookName, hookCallback);
        }.bind(this);
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'invokeHook', {
    get() {
        return function (hookName, hookCallback) {
            const self = this;
            return invokeHook.call(typesCollections.get(self), hookName, hookCallback);
        }.bind(this);
    }
});
odp(TypesCollection.prototype, 'registerFlowChecker', {
    get() {
        return function (flowCheckerCallback) {
            const self = this;
            return registerFlowChecker.call(typesCollections.get(self), flowCheckerCallback);
        }.bind(this);
    }
});
const typesCollectionProxyHandler = {
    get(target, prop) {
        if (target.subtypes.has(prop)) {
            return target.subtypes.get(prop);
        }
        return Reflect.get(target, prop);
    },
    set(target, TypeName, Constructor) {
        target.define(TypeName, Constructor);
        return true;
    },
    getOwnPropertyDescriptor(target, prop) {
        return target.subtypes.has(prop) ? {
            configurable: true,
            enumerable: true,
            writable: false,
            value: target.subtypes.get(prop)
        } : undefined;
    }
};
const createTypesCollection = (config = {}) => {
    const typesCollection = new TypesCollection(config);
    const typesCollectionProxy = new Proxy(typesCollection, typesCollectionProxyHandler);
    typesCollections.set(typesCollection, typesCollectionProxy);
    return typesCollectionProxy;
};
const DEFAULT_TYPES = createTypesCollection();
odp(DEFAULT_TYPES, SymbolDefaultTypesCollection, {
    get() {
        return true;
    }
});
exports.types = {
    get createTypesCollection() {
        return function (config = {}) {
            return createTypesCollection(config);
        };
    },
    get defaultTypes() {
        return DEFAULT_TYPES;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGVzY3JpcHRvcnMvdHlwZXMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFNYiwrQ0FBNEM7QUFDNUMsTUFBTSxFQUNMLEdBQUcsRUFDSCxxQkFBcUIsRUFDckIsNEJBQTRCLEVBQzVCLFlBQVksRUFDWixjQUFjLEVBQ2Qsa0JBQWtCLEVBQ2xCLFNBQVMsRUFDVCxTQUFTLEdBQ1QsR0FBRyxxQkFBUyxDQUFDO0FBR2QsMkNBQWlEO0FBRWpELDRDQUE0QztBQUU1QyxNQUFNLEVBQ0wsWUFBWSxFQUNaLFVBQVUsRUFDVixtQkFBbUIsR0FDbkIsR0FBRyxRQUFRLENBQUM7QUFFYixNQUFNLGdCQUFnQixHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFFbkMsTUFBTSxlQUFlLEdBQUcsVUFBVyxPQUFnQztJQUdsRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7SUFFbEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUczQixNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUUsQ0FBRSxDQUEwQixFQUFFLEdBQVcsRUFBRyxFQUFFO1FBQ3ZGLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBRSxHQUFHLENBQUUsQ0FBQztRQUM3QixNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUUsR0FBRyxDQUFFLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUcsT0FBTyxLQUFLLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQUcsT0FBTyxNQUFNLENBQUM7UUFDN0IsSUFBSyxNQUFNLEtBQUssTUFBTSxFQUFHLENBQUM7WUFDekIsQ0FBQyxDQUFFLEdBQUcsQ0FBRSxHQUFHLEtBQUssQ0FBQztRQUNsQixDQUFDO2FBQU0sQ0FBQztZQUNQLENBQUMsQ0FBRSxHQUFHLENBQUUsR0FBRyxNQUFNLENBQUM7UUFDbkIsQ0FBQztRQUNE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TSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUUsSUFBSSxDQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLFlBQVksRUFBRyxJQUFJO1lBQ25CLFVBQVUsRUFBSyxJQUFJO1lBQ25CLFFBQVEsRUFBTyxLQUFLO1lBQ3BCLEtBQUssRUFBVSxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUU7U0FDMUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ2YsQ0FBQztDQUNELENBQUM7QUFFRixNQUFNLHFCQUFxQixHQUFHLENBQUUsTUFBTSxHQUFHLEVBQUUsRUFBRyxFQUFFO0lBRS9DLE1BQU0sZUFBZSxHQUFHLElBQUksZUFBZSxDQUFFLE1BQU0sQ0FBRSxDQUFDO0lBQ3RELE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxLQUFLLENBQUUsZUFBZSxFQUFFLDJCQUEyQixDQUFFLENBQUM7SUFFdkYsZ0JBQWdCLENBQUMsR0FBRyxDQUFFLGVBQWUsRUFBRSxvQkFBb0IsQ0FBRSxDQUFDO0lBRTlELE9BQU8sb0JBQW9CLENBQUM7QUFFN0IsQ0FBQyxDQUFDO0FBRUYsTUFBTSxhQUFhLEdBQUcscUJBQXFCLEVBQUUsQ0FBQztBQUM5QyxHQUFHLENBQUUsYUFBYSxFQUFFLDRCQUE0QixFQUFFO0lBQ2pELEdBQUc7UUFDRixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7Q0FDRCxDQUFFLENBQUM7QUFFUyxRQUFBLEtBQUssR0FBRztJQUNwQixJQUFJLHFCQUFxQjtRQUN4QixPQUFPLFVBQVcsTUFBTSxHQUFHLEVBQUU7WUFDNUIsT0FBTyxxQkFBcUIsQ0FBRSxNQUFNLENBQUUsQ0FBQztRQUN4QyxDQUFDLENBQUM7SUFDSCxDQUFDO0lBQ0QsSUFBSSxZQUFZO1FBQ2YsT0FBTyxhQUFhLENBQUM7SUFDdEIsQ0FBQztDQUVELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7XG5cdENvbnN0cnVjdG9yRnVuY3Rpb25cbn0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuXG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuY29uc3Qge1xuXHRvZHAsXG5cdFN5bWJvbENvbnN0cnVjdG9yTmFtZSxcblx0U3ltYm9sRGVmYXVsdFR5cGVzQ29sbGVjdGlvbixcblx0U3ltYm9sQ29uZmlnLFxuXHRkZWZhdWx0T3B0aW9ucyxcblx0ZGVmYXVsdE9wdGlvbnNLZXlzLFxuXHRNTkVNT05JQ0EsXG5cdE1ORU1PU1lORSxcbn0gPSBjb25zdGFudHM7XG5cbi8vIGhlcmUgaXMgVHlwZXNDb2xsZWN0aW9uLmRlZmluZSgpIG1ldGhvZFxuaW1wb3J0IHsgZGVmaW5lLCBsb29rdXAgfSBmcm9tICcuLi8uLi9hcGkvdHlwZXMnO1xuXG5pbXBvcnQgKiBhcyBob29rc0FQSSBmcm9tICcuLi8uLi9hcGkvaG9va3MnO1xuXG5jb25zdCB7XG5cdHJlZ2lzdGVySG9vayxcblx0aW52b2tlSG9vayxcblx0cmVnaXN0ZXJGbG93Q2hlY2tlcixcbn0gPSBob29rc0FQSTtcblxuY29uc3QgdHlwZXNDb2xsZWN0aW9ucyA9IG5ldyBNYXAoKTtcblxuY29uc3QgVHlwZXNDb2xsZWN0aW9uID0gZnVuY3Rpb24gKCBfY29uZmlnOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiApIHtcblxuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0Y29uc3Qgc2VsZiA9IHRoaXM7XG5cblx0Y29uc3Qgc3VidHlwZXMgPSBuZXcgTWFwKCk7XG5cblx0Ly8gZGVmYXVsdCBjb25maWcgaXMgbGVzcyBpbXBvcnRhbnQgdGhhbiB0eXBlcyBjb2xsZWN0aW9uIGNvbmZpZ1xuXHRjb25zdCBjb25maWcgPSBkZWZhdWx0T3B0aW9uc0tleXMucmVkdWNlKCAoIG86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LCBrZXk6IHN0cmluZyApID0+IHtcblx0XHRjb25zdCB2YWx1ZSA9IF9jb25maWdbIGtleSBdO1xuXHRcdGNvbnN0IG9wdGlvbiA9IGRlZmF1bHRPcHRpb25zWyBrZXkgXTtcblx0XHRjb25zdCB0X2NvbmYgPSB0eXBlb2YgdmFsdWU7XG5cdFx0Y29uc3QgdF9vcHRzID0gdHlwZW9mIG9wdGlvbjtcblx0XHRpZiAoIHRfY29uZiA9PT0gdF9vcHRzICkge1xuXHRcdFx0b1sga2V5IF0gPSB2YWx1ZTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0b1sga2V5IF0gPSBvcHRpb247XG5cdFx0fVxuXHRcdHJldHVybiBvO1xuXHR9LCB7fSApO1xuXG5cdG9kcCggdGhpcywgU3ltYm9sQ29uZmlnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBjb25maWc7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCB0aGlzLCBTeW1ib2wuaGFzSW5zdGFuY2UsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuICggaW5zdGFuY2U6IHsgW1N5bWJvbENvbnN0cnVjdG9yTmFtZV0/OiBzdHJpbmcgfSApID0+IHtcblx0XHRcdFx0cmV0dXJuIGluc3RhbmNlWyBTeW1ib2xDb25zdHJ1Y3Rvck5hbWUgXSA9PT0gTU5FTU9OSUNBO1xuXHRcdFx0fTtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIHRoaXMsICdzdWJ0eXBlcycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHN1YnR5cGVzO1xuXHRcdH1cblx0fSApO1xuXG5cdC8vIEZvciBpbnN0YW5jZW9mIE1ORU1PU1lORVxuXHRvZHAoIHN1YnR5cGVzLCBNTkVNT1NZTkUsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0Ly8gcmV0dXJuaW5nIHByb3h5XG5cdFx0XHRyZXR1cm4gdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKTtcblx0XHR9XG5cdH0gKTtcblxuXHQvLyBGb3IgaW5zdGFuY2VvZiBNTkVNT1NZTkVcblx0b2RwKCB0aGlzLCBNTkVNT1NZTkUsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0Ly8gcmV0dXJuaW5nIHByb3h5XG5cdFx0XHRyZXR1cm4gdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKTtcblx0XHR9XG5cdH0gKTtcblxuXHRjb25zdCBob29rcyA9IE9iamVjdC5jcmVhdGUoIG51bGwgKTtcblx0b2RwKCB0aGlzLCAnaG9va3MnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBob29rcztcblx0XHR9XG5cdH0gKTtcblxufSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPG9iamVjdD47XG5cbm9kcCggVHlwZXNDb2xsZWN0aW9uLnByb3RvdHlwZSwgTU5FTU9OSUNBLCB7XG5cdGdldCAoKSB7XG5cdFx0cmV0dXJuIHR5cGVzQ29sbGVjdGlvbnMuZ2V0KCB0aGlzICk7XG5cdH1cbn0gKTtcblxub2RwKCBUeXBlc0NvbGxlY3Rpb24ucHJvdG90eXBlLCAnZGVmaW5lJywge1xuXHRnZXQgKHRoaXM6IHsgc3VidHlwZXM6IE1hcDxzdHJpbmcsIG9iamVjdD4gfSkge1xuXHRcdGNvbnN0IHtcblx0XHRcdHN1YnR5cGVzXG5cdFx0fSA9IHRoaXM7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uIChcblx0XHRcdHRoaXM6IHVua25vd24sXG5cdFx0XHRUeXBlT3JUeXBlTmFtZTogc3RyaW5nIHwgQ2FsbGFibGVGdW5jdGlvbixcblx0XHRcdGNvbnN0cnVjdEhhbmRsZXJPckNvbmZpZz86IENhbGxhYmxlRnVuY3Rpb24gfCBvYmplY3QsXG5cdFx0XHRjb25maWc/OiBvYmplY3Rcblx0XHQpIHtcblx0XHRcdC8vIHRoaXMgLSBkZWZpbmUgZnVuY3Rpb24gb2YgbW5lbW9uaWNhIGludGVyZmFjZVxuXHRcdFx0cmV0dXJuIGRlZmluZS5jYWxsKCB0aGlzIGFzIENhbGxhYmxlRnVuY3Rpb24sIHN1YnR5cGVzIGFzIE1hcDxzdHJpbmcsIG9iamVjdD4sIFR5cGVPclR5cGVOYW1lLCBjb25zdHJ1Y3RIYW5kbGVyT3JDb25maWcsIGNvbmZpZyApO1xuXHRcdH07XG5cdH0sXG5cdGVudW1lcmFibGUgOiB0cnVlXG59ICk7XG5cbm9kcCggVHlwZXNDb2xsZWN0aW9uLnByb3RvdHlwZSwgJ2xvb2t1cCcsIHtcblx0Z2V0ICh0aGlzOiB7IHN1YnR5cGVzOiBNYXA8c3RyaW5nLCBvYmplY3Q+IH0pIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKFxuXHRcdFx0dGhpczogeyBzdWJ0eXBlczogTWFwPHN0cmluZywgb2JqZWN0PiB9LFxuXHRcdFx0VHlwZU5lc3RlZFBhdGg6IHN0cmluZ1xuXHRcdCkge1xuXHRcdFx0cmV0dXJuIGxvb2t1cC5jYWxsKCB0aGlzLnN1YnR5cGVzLCBUeXBlTmVzdGVkUGF0aCApO1xuXHRcdH0uYmluZCggdGhpcyApO1xuXHR9LFxuXHRlbnVtZXJhYmxlIDogdHJ1ZVxufSApO1xuXG5vZHAoIFR5cGVzQ29sbGVjdGlvbi5wcm90b3R5cGUsICdyZWdpc3Rlckhvb2snLCB7XG5cdGdldCAoKSB7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdFx0Y29uc3Qgc2VsZiA9IHRoaXM7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICggdGhpczogdW5rbm93biwgaG9va05hbWU6IHN0cmluZywgaG9va0NhbGxiYWNrOiBDYWxsYWJsZUZ1bmN0aW9uICkge1xuXHRcdFx0Ly8gcmV0dXJuIHByb3RvLnJlZ2lzdGVySG9vay5jYWxsKCB0eXBlc0NvbGxlY3Rpb25zLmdldCggc2VsZiApLCBob29rTmFtZSwgaG9va0NhbGxiYWNrICk7XG5cdFx0XHRyZXR1cm4gcmVnaXN0ZXJIb29rLmNhbGwoIHNlbGYsIGhvb2tOYW1lLCBob29rQ2FsbGJhY2sgKTtcblx0XHR9LmJpbmQoIHRoaXMgKTtcblx0fSxcblx0ZW51bWVyYWJsZSA6IHRydWVcbn0gKTtcblxub2RwKCBUeXBlc0NvbGxlY3Rpb24ucHJvdG90eXBlLCAnaW52b2tlSG9vaycsIHtcblx0Z2V0ICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKCB0aGlzOiB1bmtub3duLCBob29rTmFtZTogc3RyaW5nLCBob29rQ2FsbGJhY2s6IENhbGxhYmxlRnVuY3Rpb24gKSB7XG5cdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0XHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXHRcdFx0Ly8gcmV0dXJuIHByb3RvLmludm9rZUhvb2suY2FsbCggdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKSwgaG9va05hbWUsIGhvb2tDYWxsYmFjayApO1xuXHRcdFx0cmV0dXJuIGludm9rZUhvb2suY2FsbCggdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKSwgaG9va05hbWUsIGhvb2tDYWxsYmFjayApO1xuXHRcdH0uYmluZCggdGhpcyApO1xuXHR9XG59ICk7XG5cbm9kcCggVHlwZXNDb2xsZWN0aW9uLnByb3RvdHlwZSwgJ3JlZ2lzdGVyRmxvd0NoZWNrZXInLCB7XG5cdGdldCAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICggdGhpczogdW5rbm93biwgZmxvd0NoZWNrZXJDYWxsYmFjazogKCkgPT4gdW5rbm93biApIHtcblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRcdFx0Y29uc3Qgc2VsZiA9IHRoaXM7XG5cdFx0XHRyZXR1cm4gcmVnaXN0ZXJGbG93Q2hlY2tlci5jYWxsKCB0eXBlc0NvbGxlY3Rpb25zLmdldCggc2VsZiApLCBmbG93Q2hlY2tlckNhbGxiYWNrICk7XG5cdFx0fS5iaW5kKCB0aGlzICk7XG5cdH1cbn0gKTtcblxuXG5pbnRlcmZhY2UgVHlwZXNDb2xsZWN0aW9uVGFyZ2V0IHtcblx0c3VidHlwZXM6IE1hcDxzdHJpbmcsIG9iamVjdD47XG5cdGRlZmluZTogKG5hbWU6IHN0cmluZywgY3RvcjogRnVuY3Rpb25Db25zdHJ1Y3RvcikgPT4gb2JqZWN0O1xufVxuXG5jb25zdCB0eXBlc0NvbGxlY3Rpb25Qcm94eUhhbmRsZXIgPSB7XG5cdGdldCAoIHRhcmdldDogVHlwZXNDb2xsZWN0aW9uVGFyZ2V0LCBwcm9wOiBzdHJpbmcgKSB7XG5cdFx0aWYgKCB0YXJnZXQuc3VidHlwZXMuaGFzKCBwcm9wICkgKSB7XG5cdFx0XHRyZXR1cm4gdGFyZ2V0LnN1YnR5cGVzLmdldCggcHJvcCApO1xuXHRcdH1cblx0XHRyZXR1cm4gUmVmbGVjdC5nZXQoIHRhcmdldCwgcHJvcCApO1xuXHR9LFxuXHRzZXQgKCB0YXJnZXQ6IFR5cGVzQ29sbGVjdGlvblRhcmdldCwgVHlwZU5hbWU6IHN0cmluZywgQ29uc3RydWN0b3I6IEZ1bmN0aW9uQ29uc3RydWN0b3IgKSB7XG5cdFx0dGFyZ2V0LmRlZmluZSggVHlwZU5hbWUsIENvbnN0cnVjdG9yICk7XG5cdFx0cmV0dXJuIHRydWU7XG5cdH0sXG5cdC8vIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbFxuXHRnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgKCB0YXJnZXQ6IFR5cGVzQ29sbGVjdGlvblRhcmdldCwgcHJvcDogc3RyaW5nICkge1xuXHRcdHJldHVybiB0YXJnZXQuc3VidHlwZXMuaGFzKCBwcm9wICkgPyB7XG5cdFx0XHRjb25maWd1cmFibGUgOiB0cnVlLFxuXHRcdFx0ZW51bWVyYWJsZSAgIDogdHJ1ZSxcblx0XHRcdHdyaXRhYmxlICAgICA6IGZhbHNlLFxuXHRcdFx0dmFsdWUgICAgICAgIDogdGFyZ2V0LnN1YnR5cGVzLmdldCggcHJvcCApXG5cdFx0fSA6IHVuZGVmaW5lZDtcblx0fVxufTtcblxuY29uc3QgY3JlYXRlVHlwZXNDb2xsZWN0aW9uID0gKCBjb25maWcgPSB7fSApID0+IHtcblxuXHRjb25zdCB0eXBlc0NvbGxlY3Rpb24gPSBuZXcgVHlwZXNDb2xsZWN0aW9uKCBjb25maWcgKTtcblx0Y29uc3QgdHlwZXNDb2xsZWN0aW9uUHJveHkgPSBuZXcgUHJveHkoIHR5cGVzQ29sbGVjdGlvbiwgdHlwZXNDb2xsZWN0aW9uUHJveHlIYW5kbGVyICk7XG5cblx0dHlwZXNDb2xsZWN0aW9ucy5zZXQoIHR5cGVzQ29sbGVjdGlvbiwgdHlwZXNDb2xsZWN0aW9uUHJveHkgKTtcblxuXHRyZXR1cm4gdHlwZXNDb2xsZWN0aW9uUHJveHk7XG5cbn07XG5cbmNvbnN0IERFRkFVTFRfVFlQRVMgPSBjcmVhdGVUeXBlc0NvbGxlY3Rpb24oKTtcbm9kcCggREVGQVVMVF9UWVBFUywgU3ltYm9sRGVmYXVsdFR5cGVzQ29sbGVjdGlvbiwge1xuXHRnZXQgKCkge1xuXHRcdHJldHVybiB0cnVlO1xuXHR9XG59ICk7XG5cbmV4cG9ydCBjb25zdCB0eXBlcyA9IHtcblx0Z2V0IGNyZWF0ZVR5cGVzQ29sbGVjdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICggY29uZmlnID0ge30gKSB7XG5cdFx0XHRyZXR1cm4gY3JlYXRlVHlwZXNDb2xsZWN0aW9uKCBjb25maWcgKTtcblx0XHR9O1xuXHR9LFxuXHRnZXQgZGVmYXVsdFR5cGVzICgpIHtcblx0XHRyZXR1cm4gREVGQVVMVF9UWVBFUztcblx0fVxuXG59O1xuIl19