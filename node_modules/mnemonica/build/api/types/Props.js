'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.setProps = exports.getProps = exports._setSelf = exports._getProps = exports._addProps = void 0;
const constants_1 = require("../../constants");
const { odp, } = constants_1.constants;
const __props__ = new WeakMap();
const nativeProps = new Set([
    '__proto_proto__',
    '__args__',
    '__collection__',
    '__subtypes__',
    '__type__',
    '__parent__',
    '__stack__',
    '__creator__',
    '__timestamp__',
    '__self__',
]);
const _addProps = function () {
    const self = this;
    const { type, existentInstance, args, config: { submitStack }, __proto_proto__: proto } = self;
    const { collection, subtypes, } = type;
    const value = Object.create(null);
    odp(value, '__proto_proto__', {
        get() {
            return proto;
        }
    });
    odp(value, '__args__', {
        get() {
            return args;
        }
    });
    odp(value, '__collection__', {
        get() {
            return collection;
        }
    });
    odp(value, '__subtypes__', {
        get() {
            return subtypes;
        }
    });
    odp(value, '__type__', {
        get() {
            return type;
        }
    });
    odp(value, '__parent__', {
        get() {
            return existentInstance;
        }
    });
    if (submitStack) {
        const { stack } = this;
        odp(value, '__stack__', {
            get() {
                return stack.join('\n');
            }
        });
    }
    odp(value, '__creator__', {
        get() {
            return self;
        }
    });
    const timestamp = Date.now();
    odp(value, '__timestamp__', {
        get() {
            return timestamp;
        }
    });
    __props__.set(proto, value);
};
exports._addProps = _addProps;
const isObjectNature = (instance) => {
    if (instance instanceof Object)
        return true;
    if (typeof instance === 'object' && instance != null)
        return true;
    return false;
};
const _getProps = (instance, base) => {
    if (!isObjectNature(instance))
        return undefined;
    const proto = Reflect.getPrototypeOf(instance);
    if (base !== undefined && isObjectNature(base) && isObjectNature(proto) && (base.constructor !== proto.constructor)) {
        return undefined;
    }
    const result = __props__.get(proto);
    if (result === undefined) {
        if (base === undefined) {
            base = instance;
        }
        return (0, exports._getProps)(proto, base);
    }
    return result;
};
exports._getProps = _getProps;
const _setSelf = (instance) => {
    const props = (0, exports._getProps)(instance);
    Object.defineProperty(props, '__self__', {
        get() {
            return instance;
        }
    });
    __props__.set(instance, props);
};
exports._setSelf = _setSelf;
const getProps = (instance) => {
    const props = (0, exports._getProps)(instance);
    if (props) {
        const _additions = __props__.get(props);
        if (_additions instanceof Object) {
            const descriptors = Object.getOwnPropertyDescriptors(props);
            const additions = Object.getOwnPropertyDescriptors(_additions);
            const answer = {};
            Object.defineProperties(answer, additions);
            Object.defineProperties(answer, descriptors);
            return answer;
        }
        else {
            return props;
        }
    }
    return undefined;
};
exports.getProps = getProps;
const setProps = (instance, _values) => {
    const props = (0, exports._getProps)(instance);
    if (props) {
        const values = Object.getOwnPropertyDescriptors(_values);
        const written = [];
        const allowed = {};
        Object.entries(values).forEach(([name, value]) => {
            if (!nativeProps.has(name)) {
                written.push(name);
                Object.defineProperty(allowed, name, value);
            }
        });
        __props__.set(props, allowed);
        return written;
    }
    return false;
};
exports.setProps = setProps;
module.exports = {
    _addProps: exports._addProps,
    _getProps: exports._getProps,
    _setSelf: exports._setSelf,
    getProps: exports.getProps,
    setProps: exports.setProps
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3R5cGVzL1Byb3BzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsK0NBQTRDO0FBRzVDLE1BQU0sRUFDTCxHQUFHLEdBQ0gsR0FBRyxxQkFBUyxDQUFDO0FBRWQsTUFBTSxTQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUVoQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUMzQixpQkFBaUI7SUFDakIsVUFBVTtJQUNWLGdCQUFnQjtJQUNoQixjQUFjO0lBQ2QsVUFBVTtJQUNWLFlBQVk7SUFDWixXQUFXO0lBQ1gsYUFBYTtJQUNiLGVBQWU7SUFDZixVQUFVO0NBQ1YsQ0FBQyxDQUFDO0FBRUksTUFBTSxTQUFTLEdBQUc7SUFHeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRWxCLE1BQU0sRUFDTCxJQUFJLEVBQ0osZ0JBQWdCLEVBQ2hCLElBQUksRUFDSixNQUFNLEVBQUUsRUFDUCxXQUFXLEVBQ1gsRUFDRCxlQUFlLEVBQUUsS0FBSyxFQUN0QixHQUFHLElBQUksQ0FBQztJQUVULE1BQU0sRUFDTCxVQUFVLEVBQ1YsUUFBUSxHQUNSLEdBQUcsSUFBSSxDQUFDO0lBRVQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVsQyxHQUFHLENBQUMsS0FBSyxFQUFFLGlCQUFpQixFQUFFO1FBQzdCLEdBQUc7WUFDRixPQUFPLEtBQUssQ0FBQztRQUNkLENBQUM7S0FDRCxDQUFDLENBQUM7SUFFSCxHQUFHLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRTtRQUN0QixHQUFHO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDO0tBQ0QsQ0FBQyxDQUFDO0lBRUgsR0FBRyxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsRUFBRTtRQUM1QixHQUFHO1lBQ0YsT0FBTyxV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LENBQUMsQ0FBQztRQUN6RCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUM7UUFDN0IsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBRSxJQUFJLEVBQUUsS0FBSyxDQUFFLEVBQUUsRUFBRTtZQUNsRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsQ0FBQztRQUNGLENBQUMsQ0FBQyxDQUFDO1FBQ0gsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUIsT0FBTyxPQUFPLENBQUM7SUFDaEIsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBaEJXLFFBQUEsUUFBUSxZQWdCbkI7QUFLRixNQUFNLENBQUMsT0FBTyxHQUFHO0lBQ2hCLFNBQVMsRUFBVCxpQkFBUztJQUNULFNBQVMsRUFBVCxpQkFBUztJQUNULFFBQVEsRUFBUixnQkFBUTtJQUNSLFFBQVEsRUFBUixnQkFBUTtJQUNSLFFBQVEsRUFBUixnQkFBUTtDQUNSLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgdHlwZSB7IENvbGxlY3Rpb25EZWYsIFR5cGVEZWYsIFByb3BzIGFzIFByb3BzVHlwZSB9IGZyb20gJy4uLy4uL3R5cGVzJztcblxuY29uc3Qge1xuXHRvZHAsXG59ID0gY29uc3RhbnRzO1xuXG5jb25zdCBfX3Byb3BzX18gPSBuZXcgV2Vha01hcCgpO1xuXG5jb25zdCBuYXRpdmVQcm9wcyA9IG5ldyBTZXQoW1xuXHQnX19wcm90b19wcm90b19fJyxcblx0J19fYXJnc19fJyxcblx0J19fY29sbGVjdGlvbl9fJyxcblx0J19fc3VidHlwZXNfXycsXG5cdCdfX3R5cGVfXycsXG5cdCdfX3BhcmVudF9fJyxcblx0J19fc3RhY2tfXycsXG5cdCdfX2NyZWF0b3JfXycsXG5cdCdfX3RpbWVzdGFtcF9fJyxcblx0J19fc2VsZl9fJyxcbl0pO1xuXG5leHBvcnQgY29uc3QgX2FkZFByb3BzID0gZnVuY3Rpb24gKHRoaXM6IGFueSk6IGFueSB7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdGNvbnN0IHNlbGYgPSB0aGlzO1xuXG5cdGNvbnN0IHtcblx0XHR0eXBlLFxuXHRcdGV4aXN0ZW50SW5zdGFuY2UsXG5cdFx0YXJncyxcblx0XHRjb25maWc6IHtcblx0XHRcdHN1Ym1pdFN0YWNrXG5cdFx0fSxcblx0XHRfX3Byb3RvX3Byb3RvX186IHByb3RvXG5cdH0gPSBzZWxmO1xuXG5cdGNvbnN0IHtcblx0XHRjb2xsZWN0aW9uLFxuXHRcdHN1YnR5cGVzLFxuXHR9ID0gdHlwZTtcblxuXHRjb25zdCB2YWx1ZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cblx0b2RwKHZhbHVlLCAnX19wcm90b19wcm90b19fJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gcHJvdG87XG5cdFx0fVxuXHR9KTtcblxuXHRvZHAodmFsdWUsICdfX2FyZ3NfXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGFyZ3M7XG5cdFx0fVxuXHR9KTtcblxuXHRvZHAodmFsdWUsICdfX2NvbGxlY3Rpb25fXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGNvbGxlY3Rpb247XG5cdFx0fVxuXHR9KTtcblxuXHRvZHAodmFsdWUsICdfX3N1YnR5cGVzX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBzdWJ0eXBlcztcblx0XHR9XG5cdH0pO1xuXG5cdG9kcCh2YWx1ZSwgJ19fdHlwZV9fJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gdHlwZTtcblx0XHR9XG5cdH0pO1xuXG5cdG9kcCh2YWx1ZSwgJ19fcGFyZW50X18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBleGlzdGVudEluc3RhbmNlO1xuXHRcdH1cblx0fSk7XG5cblx0aWYgKHN1Ym1pdFN0YWNrKSB7XG5cdFx0Y29uc3QgeyBzdGFjayB9ID0gdGhpcztcblx0XHRvZHAodmFsdWUsICdfX3N0YWNrX18nLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gc3RhY2suam9pbignXFxuJyk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRvZHAodmFsdWUsICdfX2NyZWF0b3JfXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHNlbGY7XG5cdFx0fVxuXHR9KTtcblxuXHRjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuXHRvZHAodmFsdWUsICdfX3RpbWVzdGFtcF9fJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gdGltZXN0YW1wO1xuXHRcdH1cblx0fSk7XG5cblx0Ly8gX19wcm9wc19fLnNldChzZWxmLCB2YWx1ZSk7XG5cdF9fcHJvcHNfXy5zZXQocHJvdG8sIHZhbHVlKTtcblxufTtcblxuY29uc3QgaXNPYmplY3ROYXR1cmUgPSAoaW5zdGFuY2U6IHVua25vd24pID0+IHtcblx0aWYgKGluc3RhbmNlIGluc3RhbmNlb2YgT2JqZWN0KSByZXR1cm4gdHJ1ZTtcblx0aWYgKHR5cGVvZiBpbnN0YW5jZSA9PT0gJ29iamVjdCcgJiYgaW5zdGFuY2UgIT0gbnVsbCkgcmV0dXJuIHRydWU7XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBjb25zdCBfZ2V0UHJvcHMgPSAoaW5zdGFuY2U6IG9iamVjdCwgYmFzZT86IG9iamVjdCk6IFByb3BzVHlwZSB8IHVuZGVmaW5lZCA9PiB7XG5cdGlmICghaXNPYmplY3ROYXR1cmUoaW5zdGFuY2UpKSByZXR1cm4gdW5kZWZpbmVkO1xuXHRjb25zdCBwcm90byA9IFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YoaW5zdGFuY2UpIGFzIG9iamVjdDtcblx0aWYgKGJhc2UgIT09IHVuZGVmaW5lZCAmJiBpc09iamVjdE5hdHVyZShiYXNlKSAmJiBpc09iamVjdE5hdHVyZShwcm90bykgJiYgKGJhc2UuY29uc3RydWN0b3IgIT09IHByb3RvLmNvbnN0cnVjdG9yKSkge1xuXHRcdC8vIGhlcmUgd2UgZ290IHJpZCBvZiB1bm5lY2Vzc2FyeSBjaGFpbiBkaXZlXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXHRjb25zdCByZXN1bHQgPSBfX3Byb3BzX18uZ2V0KHByb3RvKTtcblx0aWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0Ly8gc28gd2UganVtcGluZyBkZWVwZXIgaGVyZVxuXHRcdGlmIChiYXNlID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGJhc2UgPSBpbnN0YW5jZTtcblx0XHR9XG5cdFx0cmV0dXJuIF9nZXRQcm9wcyhwcm90bywgYmFzZSk7XG5cdH1cblx0cmV0dXJuIHJlc3VsdDtcbn07XG5cbmV4cG9ydCBjb25zdCBfc2V0U2VsZiA9IChpbnN0YW5jZTogb2JqZWN0KTogdm9pZCA9PiB7XG5cdC8vIGNvbnN0IHByb3BzID0gX19wcm9wc19fLmdldChpbnN0YW5jZSk7XG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKTtcblx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAnX19zZWxmX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBpbnN0YW5jZTtcblx0XHR9XG5cdH0pO1xuXHRfX3Byb3BzX18uc2V0KGluc3RhbmNlLCBwcm9wcyk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0UHJvcHMgPSAoaW5zdGFuY2U6IG9iamVjdCk6IFByb3BzVHlwZSB8IHVuZGVmaW5lZCA9PiB7XG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKTtcblx0aWYgKHByb3BzKSB7XG5cdFx0Y29uc3QgX2FkZGl0aW9ucyA9IF9fcHJvcHNfXy5nZXQocHJvcHMpO1xuXHRcdGlmIChfYWRkaXRpb25zIGluc3RhbmNlb2YgT2JqZWN0KSB7XG5cdFx0XHRjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHByb3BzKTtcblx0XHRcdGNvbnN0IGFkZGl0aW9ucyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKF9hZGRpdGlvbnMpO1xuXHRcdFx0Y29uc3QgYW5zd2VyID0ge307XG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydGllcyhhbnN3ZXIsIGFkZGl0aW9ucyk7XG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydGllcyhhbnN3ZXIsIGRlc2NyaXB0b3JzKTtcblx0XHRcdHJldHVybiBhbnN3ZXIgYXMgUHJvcHNUeXBlO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gcHJvcHM7XG5cdFx0fVxuXHR9XG5cdHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5leHBvcnQgY29uc3Qgc2V0UHJvcHMgPSAoaW5zdGFuY2U6IG9iamVjdCwgX3ZhbHVlczogb2JqZWN0KTogc3RyaW5nW10gfCBmYWxzZSA9PiB7XG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKTtcblx0aWYgKHByb3BzKSB7XG5cdFx0Y29uc3QgdmFsdWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoX3ZhbHVlcyk7XG5cdFx0Y29uc3Qgd3JpdHRlbjogc3RyaW5nW10gPSBbXTtcblx0XHRjb25zdCBhbGxvd2VkID0ge307XG5cdFx0T2JqZWN0LmVudHJpZXModmFsdWVzKS5mb3JFYWNoKChbIG5hbWUsIHZhbHVlIF0pID0+IHtcblx0XHRcdGlmICghbmF0aXZlUHJvcHMuaGFzKG5hbWUpKSB7XG5cdFx0XHRcdHdyaXR0ZW4ucHVzaChuYW1lKTtcblx0XHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGFsbG93ZWQsIG5hbWUsIHZhbHVlKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRfX3Byb3BzX18uc2V0KHByb3BzLCBhbGxvd2VkKTtcblx0XHRyZXR1cm4gd3JpdHRlbjtcblx0fVxuXHRyZXR1cm4gZmFsc2U7XG59O1xuXG4vLyBSZS1leHBvcnQgdHlwZXMgZnJvbSBjZW50cmFsaXplZCB0eXBlc1xuZXhwb3J0IHR5cGUgeyBDb2xsZWN0aW9uRGVmLCBUeXBlRGVmLCBQcm9wc1R5cGUgYXMgUHJvcHMgfTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cdF9hZGRQcm9wcyxcblx0X2dldFByb3BzLFxuXHRfc2V0U2VsZixcblx0Z2V0UHJvcHMsXG5cdHNldFByb3BzXG59O1xuIl19