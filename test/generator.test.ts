'use strict';

import { expect } from 'chai';
import { TypeGraphImpl } from '../src/graph';
import { TypesGenerator } from '../src/generator';
import { TypeNode } from '../src/types';

describe('TypesGenerator', () => {
	let graph: TypeGraphImpl;
	let generator: TypesGenerator;

	beforeEach(() => {
		graph = new TypeGraphImpl();
		generator = new TypesGenerator(graph);
	});

	describe('generateTypesFile', () => {
		it('should generate header with comments', () => {
			const result = generator.generateTypesFile();

			expect(result.content).to.include('Generated by @mnemonica/tactica');
			expect(result.content).to.include('DO NOT EDIT');
		});

		it('should generate type alias exports', () => {
			const node = TypeGraphImpl.createNode('FirstType', undefined, 'test.ts', 1, 1);
			graph.addRoot(node);

			const result = generator.generateTypesFile();

			expect(result.content).to.include('export type FirstTypeInstance');
		});

		it('should return types array', () => {
			const node = TypeGraphImpl.createNode('User', undefined, 'test.ts', 1, 1);
			node.properties.set('name', { name: 'name', type: 'string', optional: false });
			graph.addRoot(node);

			const result = generator.generateTypesFile();

			expect(result.types).to.include('UserInstance');
		});
	});

	describe('generateGlobalAugmentation', () => {
		it('should generate global declaration', () => {
			const node = TypeGraphImpl.createNode('FirstType', undefined, 'test.ts', 1, 1);
			graph.addRoot(node);

			const result = generator.generateGlobalAugmentation();

			expect(result.content).to.include('declare global');
			expect(result.content).to.include('FirstTypeInstance');
		});

		it('should generate instance type alias', () => {
			const node = TypeGraphImpl.createNode('FirstType', undefined, 'test.ts', 1, 1);
			graph.addRoot(node);

			const result = generator.generateGlobalAugmentation();

			expect(result.content).to.include('type FirstTypeInstance');
		});

		it('should generate nested constructor properties', () => {
			const parent = TypeGraphImpl.createNode('Parent', undefined, 'test.ts', 1, 1);
			const child = TypeGraphImpl.createNode('Child', parent, 'test.ts', 5, 1);
			
			graph.addRoot(parent);
			graph.addChild(parent, child);

			const result = generator.generateGlobalAugmentation();

			expect(result.content).to.include('ParentInstance');
			expect(result.content).to.include('Child:');
			expect(result.content).to.include('TypeConstructor<ChildInstance>');
		});

		it('should include parent in intersection type', () => {
			const parent = TypeGraphImpl.createNode('Parent', undefined, 'test.ts', 1, 1);
			const child = TypeGraphImpl.createNode('Child', parent, 'test.ts', 5, 1);
			
			graph.addRoot(parent);
			graph.addChild(parent, child);

			const result = generator.generateGlobalAugmentation();

			expect(result.content).to.include('ChildInstance = ParentInstance &');
		});
	});
});
